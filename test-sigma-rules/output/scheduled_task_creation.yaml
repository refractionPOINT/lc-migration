detect:
  event: NEW_PROCESS
  op: and
  rules:
  - op: is windows
  - op: ends with
    path: event/FILE_PATH
    value: \schtasks.exe
    case sensitive: false
  - op: contains
    path: event/COMMAND_LINE
    value: ' /create '
    case sensitive: false
  - op: contains
    not: true
    path: event/USER_NAME
    value: AUTHORI
    case sensitive: false
  - op: contains
    not: true
    path: event/USER_NAME
    value: AUTORI
    case sensitive: false
respond:
- action: report
  name: Scheduled Task Creation by {{ .event.USER_NAME }}
  publish: true
  priority: 3
  metadata:
    description: Detects the creation of scheduled tasks by user accounts via the
      'schtasks' utility. This could indicate persistence, privilege escalation, or
      execution of malicious code. Excludes common system users.
    author: Florian Roth (Nextron Systems) / LimaCharlie
    references:
    - https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/schtasks-create
    mitre_attack:
    - T1053.005
    - S0111
    level: low
    status: test
    false_positives:
    - Legitimate administrative activity
    - Software installation
    - System management scripts
    tags:
    - attack.execution
    - attack.persistence
    - attack.privilege-escalation
    - car.2013-08-001
    - stp.1u
    - windows.scheduled_task
    - schtasks.exe
- action: task
  command: history_dump
  investigation: schtasks-creation-investigation
  suppression:
    max_count: 1
    period: 1h
    is_global: false
    keys:
    - '{{ .event.PROCESS_ID }}'
    - schtasks-history-dump
- action: add tag
  tag: suspicious-scheduled-task-creation
  ttl: 3600
