detect:
  event: NETWORK_CONNECTIONS
  op: and
  rules:
  - op: is windows
  - op: scope
    path: event/NETWORK_ACTIVITY/
    rule:
      op: and
      rules:
      - op: or
        rules:
        - op: is
          path: event/SOURCE/PORT
          value: 3389
        - op: is
          path: event/DESTINATION/PORT
          value: 3389
      - op: or
        rules:
        - op: starts with
          path: event/SOURCE/IP_ADDRESS
          value: '127.'
        - op: is
          path: event/SOURCE/IP_ADDRESS
          value: ::1
        - op: starts with
          path: event/DESTINATION/IP_ADDRESS
          value: '127.'
        - op: is
          path: event/DESTINATION/IP_ADDRESS
          value: ::1
  - op: or
    not: true
    rules:
    - op: ends with
      path: event/FILE_PATH
      value: \thor.exe
      case sensitive: false
    - op: ends with
      path: event/FILE_PATH
      value: \thor64.exe
      case sensitive: false
respond:
- action: report
  name: RDP over Reverse Tunnel Detected on {{ .routing.hostname }}
  publish: true
  priority: 3
  metadata:
    author: Samir Bousseaden
    description: Detects svchost hosting RDP termsvcs communicating with the loopback
      address, indicative of RDP over a reverse SSH tunnel. This technique is often
      used for defense evasion and lateral movement.
    references:
    - https://twitter.com/SBousseaden/status/109614822984384514
    - https://github.com/sbousseaden/EVTX-ATTACK-SAMPLES/blob/44fbe85f72ee91582876b49678f9a26292a155fb/Command%20and%20Control/DE_RDP_Tunnel_5156.evtx
    mitre_attack:
    - T1090.001
    - T1090.002
    - T1021.001
    level: high
    status: test
    false_positives:
    - Programs that connect locally to the RDP port
    tags:
    - attack.defense-evasion
    - attack.command-and-control
    - attack.lateral-movement
    - car.2013-07-002
- action: task
  command: history_dump
  investigation: rdp-reverse-tunnel-investigation
  suppression:
    is_global: false
    keys:
    - '{{ .event.PROCESS_ID }}'
    - rdp-reverse-tunnel-history-dump
    max_count: 1
    period: 1h
- action: task
  command: artifact_get --file "{{ .event.FILE_PATH }}" --days-retention 7
  investigation: rdp-reverse-tunnel-artifact-collection
  suppression:
    is_global: false
    keys:
    - '{{ .event.FILE_PATH }}'
    - rdp-reverse-tunnel-artifact-get
    max_count: 1
    period: 24h
- action: add tag
  tag: rdp-reverse-tunnel-detected
  ttl: 3600
  entire_device: false
