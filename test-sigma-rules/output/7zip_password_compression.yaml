detect:
  event: NEW_PROCESS
  op: and
  rules:
  - op: is windows
  - op: or
    rules:
    - op: contains
      path: event/FILE_DESCRIPTION
      value: 7-Zip
      case sensitive: false
    - op: or
      rules:
      - op: ends with
        path: event/FILE_PATH
        value: \7z.exe
        case sensitive: false
      - op: ends with
        path: event/FILE_PATH
        value: \7zr.exe
        case sensitive: false
      - op: ends with
        path: event/FILE_PATH
        value: \7za.exe
        case sensitive: false
    - op: or
      rules:
      - op: is
        path: event/ORIGINAL_FILE_NAME
        value: 7z.exe
        case sensitive: false
      - op: is
        path: event/ORIGINAL_FILE_NAME
        value: 7za.exe
        case sensitive: false
  - op: contains
    path: event/COMMAND_LINE
    value: ' -p'
    case sensitive: false
  - op: or
    rules:
    - op: contains
      path: event/COMMAND_LINE
      value: ' a '
      case sensitive: false
    - op: contains
      path: event/COMMAND_LINE
      value: ' u '
      case sensitive: false
respond:
- action: report
  name: 7zip Password Compression Detected - {{ .event.FILE_PATH }}
  publish: true
  priority: 4
  metadata:
    author: frack113
    description: An adversary may compress or encrypt data that is collected prior
      to exfiltration using 3rd party utilities. Detected 7-Zip being used with password
      protection (T1560.001).
    references:
    - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1560.001/T1560.001.md
    mitre_attack:
    - T1560.001
    level: medium
    status: test
    false_positives:
    - Legitimate activity is expected since compressing files with a password is common.
    tags:
    - attack.collection
    - attack.t1560.001
- action: task
  command: history_dump
  investigation: 7zip-password-compression-investigation
  suppression:
    max_count: 1
    period: 1h
    is_global: false
    keys:
    - '{{ .event.PROCESS_ID }}'
    - 7zip-history-dump
- action: add tag
  tag: suspicious-7zip-compression
  ttl: 3600
  entire_device: false
