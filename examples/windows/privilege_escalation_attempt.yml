---
name: Windows Privilege Escalation via Token Manipulation
description: Detects attempts to escalate privileges using token manipulation techniques
platform: windows
severity: high
data_source: Windows Security Event Logs / EDR telemetry

detection:
  event_types:
    - NEW_PROCESS
    - SECURITY_EVENT_4688  # A new process has been created

  conditions:
    # Look for common privilege escalation tools
    - process_name:
        - whoami.exe
        - net.exe
        - net1.exe
        - powershell.exe
        - cmd.exe

    # With specific command line patterns
    - command_line_contains:
        - "whoami /priv"
        - "whoami /groups"
        - "net localgroup administrators"
        - "SeDebugPrivilege"
        - "SeTakeOwnershipPrivilege"
        - "ImpersonatePrivilege"

    # Exclude legitimate admin activity
    - exclude:
        - parent_process: "C:\\Windows\\System32\\services.exe"
        - user: "NT AUTHORITY\\SYSTEM"

response:
  alert:
    name: "Potential Privilege Escalation - Token Manipulation"
    severity: high
    category: privilege_escalation

  include_fields:
    - process_path
    - command_line
    - parent_process
    - user
    - hostname

  actions:
    - report_detection
    - tag_host: "privilege_escalation_attempt"

mitre_attack:
  - T1134    # Access Token Manipulation
  - T1068    # Exploitation for Privilege Escalation

references:
  - https://attack.mitre.org/techniques/T1134/
